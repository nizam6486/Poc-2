---
- name: Update kubeconfig for EKS cluster
  shell: aws eks update-kubeconfig --region {{ aws_region }} --name {{ eks_cluster_name }}
  environment:
    AWS_DEFAULT_REGION: "{{ aws_region }}"

- name: Generate Apache Kubernetes manifest
  template:
    src: apache-deployment.yaml.j2
    dest: /tmp/apache-deployment.yaml

- name: Deploy Apache to EKS cluster
  shell: kubectl apply -f /tmp/apache-deployment.yaml

- name: Wait for Apache deployment to be ready
  shell: kubectl wait --for=condition=available --timeout=300s deployment/{{ apache_app_name }} -n {{ apache_namespace }}

- name: Get Apache service details
  shell: kubectl get service {{ apache_app_name }}-service -n {{ apache_namespace }} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
  register: apache_lb_hostname
  ignore_errors: true

- name: Display Apache service URL
  debug:
    msg: "Apache web server deployed. LoadBalancer URL: {{ apache_lb_hostname.stdout | default('Pending...') }}"