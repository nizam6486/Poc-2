---
- name: Get VPC information for cleanup
  amazon.aws.ec2_vpc_net_info:
    region: "{{ aws_region | default('us-east-1') }}"
    filters:
      "tag:Environment": "{{ env_name }}"
      "tag:ManagedBy": "ansible"
  register: vpc_info

- name: Debug VPC info
  debug:
    var: vpc_info

- name: Show cleanup summary
  debug:
    msg: |
      🔍 Cleanup Search Results:
      Environment: {{ env_name }}
      VPCs Found: {{ vpc_info.vpcs | length }}
      {% if vpc_info.vpcs %}
      VPC IDs: {{ vpc_info.vpcs | map(attribute='id') | list }}
      {% endif %}

      {% if vpc_info.vpcs | length == 0 %}
      ℹ️  No VPCs found matching criteria. Nothing to clean up.
      {% endif %}

- name: Skip cleanup if no VPCs found
  meta: end_play
  when: vpc_info.vpcs | length == 0

- block:
    - name: Get NAT Gateways in VPC
      amazon.aws.ec2_vpc_nat_gateway_info:
        region: "{{ aws_region | default('us-east-1') }}"
        filters:
          vpc-id: "{{ vpc_info.vpcs[0].id }}"
          "tag:Environment": "{{ env_name }}"
      register: nat_gateways_info

    - name: Delete NAT Gateways
      amazon.aws.ec2_vpc_nat_gateway:
        state: absent
        nat_gateway_id: "{{ item.nat_gateway_id }}"
        region: "{{ aws_region | default('us-east-1') }}"
        wait: true
        wait_timeout: 600
      loop: "{{ nat_gateways_info.nat_gateways }}"
      when: nat_gateways_info.nat_gateways | length > 0

    - name: Get subnets in VPC
      amazon.aws.ec2_vpc_subnet_info:
        region: "{{ aws_region | default('us-east-1') }}"
        filters:
          vpc-id: "{{ vpc_info.vpcs[0].id }}"
      register: subnets_info

    - name: Get route tables in VPC
      amazon.aws.ec2_vpc_route_table_info:
        region: "{{ aws_region | default('us-east-1') }}"
        filters:
          vpc-id: "{{ vpc_info.vpcs[0].id }}"
      register: route_tables_info

    - name: Delete custom route tables (non-main)
      amazon.aws.ec2_vpc_route_table:
        state: absent
        route_table_id: "{{ item.route_table_id }}"
        region: "{{ aws_region | default('us-east-1') }}"
      loop: "{{ route_tables_info.route_tables }}"
      when: not item.main
      loop_control:
        label: "{{ item.tags.Name | default(item.route_table_id) }}"

    - name: Delete subnets
      amazon.aws.ec2_vpc_subnet:
        state: absent
        subnet_id: "{{ item.id }}"
        region: "{{ aws_region | default('us-east-1') }}"
      loop: "{{ subnets_info.subnets }}"
      loop_control:
        label: "{{ item.tags.Name | default(item.id) }}"

    - name: Get Internet Gateways in VPC
      amazon.aws.ec2_vpc_igw_info:
        region: "{{ aws_region | default('us-east-1') }}"
        filters:
          attachment.vpc-id: "{{ vpc_info.vpcs[0].id }}"
      register: igw_info

    - name: Detach and delete Internet Gateway
      block:
        - name: Detach Internet Gateway from VPC
          amazon.aws.ec2_vpc_igw:
            state: detached
            vpc_id: "{{ vpc_info.vpcs[0].id }}"
            region: "{{ aws_region | default('us-east-1') }}"
          when: igw_info.gateways | length > 0

        - name: Delete Internet Gateway
          amazon.aws.ec2_vpc_igw:
            state: absent
            igw_id: "{{ item.internet_gateway_id }}"
            region: "{{ aws_region | default('us-east-1') }}"
          loop: "{{ igw_info.gateways }}"
          when: igw_info.gateways | length > 0
          loop_control:
            label: "{{ item.tags.Name | default(item.internet_gateway_id) }}"

    - name: Delete VPC
      amazon.aws.ec2_vpc_net:
        state: absent
        vpc_id: "{{ vpc_info.vpcs[0].id }}"
        region: "{{ aws_region | default('us-east-1') }}"
      register: vpc_delete_result

    - name: Show destruction summary
      debug:
        msg: |
          ✅ Successfully destroyed VPC infrastructure for environment '{{ env_name }}'
          📝 VPC ID: {{ vpc_info.vpcs[0].id }}
          🌐 Deleted: {{ subnets_info.subnets | length }} subnets
          🚦 Deleted: {{ route_tables_info.route_tables | selectattr('main', 'false') | list | length }} route tables
          🌍 Deleted: {{ igw_info.gateways | length }} internet gateways
          🔄 Deleted: {{ nat_gateways_info.nat_gateways | length }} NAT gateways
  when: vpc_info.vpcs | length > 0
